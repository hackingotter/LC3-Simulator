
	; the TRAP vector table
	
	.ORIG x0000
    .FILL 612	; x00
    .FILL 612	; x01
    .FILL 612	; x02
    .FILL 612	; x03
    .FILL 612	; x04
    .FILL 612	; x05
    .FILL 612	; x06
    .FILL 612	; x07
    .FILL 612	; x08
    .FILL 612	; x09
    .FILL 612	; x0A
    .FILL 612	; x0B
    .FILL 612	; x0C
    .FILL 612	; x0D
    .FILL 612	; x0E
    .FILL 612	; x0F
    .FILL 612	; x10
    .FILL 612	; x11
    .FILL 612	; x12
    .FILL 612	; x13
    .FILL 612	; x14
    .FILL 612	; x15
    .FILL 612	; x16
    .FILL 612	; x17
    .FILL 612	; x18
    .FILL 612	; x19
    .FILL 612	; x1A
    .FILL 612	; x1B
    .FILL 612	; x1C
    .FILL 612	; x1D
    .FILL 612	; x1E
    .FILL 612	; x1F
    .FILL 541	; x20
    .FILL 545	; x21
    .FILL 551	; x22
    .FILL 564	; x23
    .FILL 576	; x24
    .FILL 607	; x25
    .FILL 612	; x26
    .FILL 612	; x27
    .FILL 612	; x28
    .FILL 612	; x29
    .FILL 612	; x2A
    .FILL 612	; x2B
    .FILL 612	; x2C
    .FILL 612	; x2D
    .FILL 612	; x2E
    .FILL 612	; x2F
    .FILL 612	; x30
    .FILL 612	; x31
    .FILL 612	; x32
    .FILL 612	; x33
    .FILL 612	; x34
    .FILL 612	; x35
    .FILL 612	; x36
    .FILL 612	; x37
    .FILL 612	; x38
    .FILL 612	; x39
    .FILL 612	; x3A
    .FILL 612	; x3B
    .FILL 612	; x3C
    .FILL 612	; x3D
    .FILL 612	; x3E
    .FILL 612	; x3F
    .FILL 612	; x40
    .FILL 612	; x41
    .FILL 612	; x42
    .FILL 612	; x43
    .FILL 612	; x44
    .FILL 612	; x45
    .FILL 612	; x46
    .FILL 612	; x47
    .FILL 612	; x48
    .FILL 612	; x49
    .FILL 612	; x4A
    .FILL 612	; x4B
    .FILL 612	; x4C
    .FILL 612	; x4D
    .FILL 612	; x4E
    .FILL 612	; x4F
    .FILL 612	; x50
    .FILL 612	; x51
    .FILL 612	; x52
    .FILL 612	; x53
    .FILL 612	; x54
    .FILL 612	; x55
    .FILL 612	; x56
    .FILL 612	; x57
    .FILL 612	; x58
    .FILL 612	; x59
    .FILL 612	; x5A
    .FILL 612	; x5B
    .FILL 612	; x5C
    .FILL 612	; x5D
    .FILL 612	; x5E
    .FILL 612	; x5F
    .FILL 612	; x60
    .FILL 612	; x61
    .FILL 612	; x62
    .FILL 612	; x63
    .FILL 612	; x64
    .FILL 612	; x65
    .FILL 612	; x66
    .FILL 612	; x67
    .FILL 612	; x68
    .FILL 612	; x69
    .FILL 612	; x6A
    .FILL 612	; x6B
    .FILL 612	; x6C
    .FILL 612	; x6D
    .FILL 612	; x6E
    .FILL 612	; x6F
    .FILL 612	; x70
    .FILL 612	; x71
    .FILL 612	; x72
    .FILL 612	; x73
    .FILL 612	; x74
    .FILL 612	; x75
    .FILL 612	; x76
    .FILL 612	; x77
    .FILL 612	; x78
    .FILL 612	; x79
    .FILL 612	; x7A
    .FILL 612	; x7B
    .FILL 612	; x7C
    .FILL 612	; x7D
    .FILL 612	; x7E
    .FILL 612	; x7F
    .FILL 612	; x80
    .FILL 612	; x81
    .FILL 612	; x82
    .FILL 612	; x83
    .FILL 612	; x84
    .FILL 612	; x85
    .FILL 612	; x86
    .FILL 612	; x87
    .FILL 612	; x88
    .FILL 612	; x89
    .FILL 612	; x8A
    .FILL 612	; x8B
    .FILL 612	; x8C
    .FILL 612	; x8D
    .FILL 612	; x8E
    .FILL 612	; x8F
    .FILL 612	; x90
    .FILL 612	; x91
    .FILL 612	; x92
    .FILL 612	; x93
    .FILL 612	; x94
    .FILL 612	; x95
    .FILL 612	; x96
    .FILL 612	; x97
    .FILL 612	; x98
    .FILL 612	; x99
    .FILL 612	; x9A
    .FILL 612	; x9B
    .FILL 612	; x9C
    .FILL 612	; x9D
    .FILL 612	; x9E
    .FILL 612	; x9F
    .FILL 612	; xA0
    .FILL 612	; xA1
    .FILL 612	; xA2
    .FILL 612	; xA3
    .FILL 612	; xA4
    .FILL 612	; xA5
    .FILL 612	; xA6
    .FILL 612	; xA7
    .FILL 612	; xA8
    .FILL 612	; xA9
    .FILL 612	; xAA
    .FILL 612	; xAB
    .FILL 612	; xAC
    .FILL 612	; xAD
    .FILL 612	; xAE
    .FILL 612	; xAF
    .FILL 612	; xB0
    .FILL 612	; xB1
    .FILL 612	; xB2
    .FILL 612	; xB3
    .FILL 612	; xB4
    .FILL 612	; xB5
    .FILL 612	; xB6
    .FILL 612	; xB7
    .FILL 612	; xB8
    .FILL 612	; xB9
    .FILL 612	; xBA
    .FILL 612	; xBB
    .FILL 612	; xBC
    .FILL 612	; xBD
    .FILL 612	; xBE
    .FILL 612	; xBF
    .FILL 612	; xC0
    .FILL 612	; xC1
    .FILL 612	; xC2
    .FILL 612	; xC3
    .FILL 612	; xC4
    .FILL 612	; xC5
    .FILL 612	; xC6
    .FILL 612	; xC7
    .FILL 612	; xC8
    .FILL 612	; xC9
    .FILL 612	; xCA
    .FILL 612	; xCB
    .FILL 612	; xCC
    .FILL 612	; xCD
    .FILL 612	; xCE
    .FILL 612	; xCF
    .FILL 612	; xD0
    .FILL 612	; xD1
    .FILL 612	; xD2
    .FILL 612	; xD3
    .FILL 612	; xD4
    .FILL 612	; xD5
    .FILL 612	; xD6
    .FILL 612	; xD7
    .FILL 612	; xD8
    .FILL 612	; xD9
    .FILL 612	; xDA
    .FILL 612	; xDB
    .FILL 612	; xDC
    .FILL 612	; xDD
    .FILL 612	; xDE
    .FILL 612	; xDF
    .FILL 612	; xE0
    .FILL 612	; xE1
    .FILL 612	; xE2
    .FILL 612	; xE3
    .FILL 612	; xE4
    .FILL 612	; xE5
    .FILL 612	; xE6
    .FILL 612	; xE7
    .FILL 612	; xE8
    .FILL 612	; xE9
    .FILL 612	; xEA
    .FILL 612	; xEB
    .FILL 612	; xEC
    .FILL 612	; xED
    .FILL 612	; xEE
    .FILL 612	; xEF
    .FILL 612	; xF0
    .FILL 612	; xF1
    .FILL 612	; xF2
    .FILL 612	; xF3
    .FILL 612	; xF4
    .FILL 612	; xF5
    .FILL 612	; xF6
    .FILL 612	; xF7
    .FILL 612	; xF8
    .FILL 612	; xF9
    .FILL 612	; xFA
    .FILL 612	; xFB
    .FILL 612	; xFC
    .FILL 612	; xFD
    .FILL 612	; xFE
    .FILL 612	; xFF
	; the interrupt vector table
	; interrupts are not currently implemented
	
    .FILL 613	; x00
    .FILL 613	; x01
    .FILL 613	; x02
    .FILL 613	; x03
    .FILL 613	; x04
    .FILL 613	; x05
    .FILL 613	; x06
    .FILL 613	; x07
    .FILL 613	; x08
    .FILL 613	; x09
    .FILL 613	; x0A
    .FILL 613	; x0B
    .FILL 613	; x0C
    .FILL 613	; x0D
    .FILL 613	; x0E
    .FILL 613	; x0F
    .FILL 613	; x10
    .FILL 613	; x11
    .FILL 613	; x12
    .FILL 613	; x13
    .FILL 613	; x14
    .FILL 613	; x15
    .FILL 613	; x16
    .FILL 613	; x17
    .FILL 613	; x18
    .FILL 613	; x19
    .FILL 613	; x1A
    .FILL 613	; x1B
    .FILL 613	; x1C
    .FILL 613	; x1D
    .FILL 613	; x1E
    .FILL 613	; x1F
    .FILL 613	; x20
    .FILL 613	; x21
    .FILL 613	; x22
    .FILL 613	; x23
    .FILL 613	; x24
    .FILL 613	; x25
    .FILL 613	; x26
    .FILL 613	; x27
    .FILL 613	; x28
    .FILL 613	; x29
    .FILL 613	; x2A
    .FILL 613	; x2B
    .FILL 613	; x2C
    .FILL 613	; x2D
    .FILL 613	; x2E
    .FILL 613	; x2F
    .FILL 613	; x30
    .FILL 613	; x31
    .FILL 613	; x32
    .FILL 613	; x33
    .FILL 613	; x34
    .FILL 613	; x35
    .FILL 613	; x36
    .FILL 613	; x37
    .FILL 613	; x38
    .FILL 613	; x39
    .FILL 613	; x3A
    .FILL 613	; x3B
    .FILL 613	; x3C
    .FILL 613	; x3D
    .FILL 613	; x3E
    .FILL 613	; x3F
    .FILL 613	; x40
    .FILL 613	; x41
    .FILL 613	; x42
    .FILL 613	; x43
    .FILL 613	; x44
    .FILL 613	; x45
    .FILL 613	; x46
    .FILL 613	; x47
    .FILL 613	; x48
    .FILL 613	; x49
    .FILL 613	; x4A
    .FILL 613	; x4B
    .FILL 613	; x4C
    .FILL 613	; x4D
    .FILL 613	; x4E
    .FILL 613	; x4F
    .FILL 613	; x50
    .FILL 613	; x51
    .FILL 613	; x52
    .FILL 613	; x53
    .FILL 613	; x54
    .FILL 613	; x55
    .FILL 613	; x56
    .FILL 613	; x57
    .FILL 613	; x58
    .FILL 613	; x59
    .FILL 613	; x5A
    .FILL 613	; x5B
    .FILL 613	; x5C
    .FILL 613	; x5D
    .FILL 613	; x5E
    .FILL 613	; x5F
    .FILL 613	; x60
    .FILL 613	; x61
    .FILL 613	; x62
    .FILL 613	; x63
    .FILL 613	; x64
    .FILL 613	; x65
    .FILL 613	; x66
    .FILL 613	; x67
    .FILL 613	; x68
    .FILL 613	; x69
    .FILL 613	; x6A
    .FILL 613	; x6B
    .FILL 613	; x6C
    .FILL 613	; x6D
    .FILL 613	; x6E
    .FILL 613	; x6F
    .FILL 613	; x70
    .FILL 613	; x71
    .FILL 613	; x72
    .FILL 613	; x73
    .FILL 613	; x74
    .FILL 613	; x75
    .FILL 613	; x76
    .FILL 613	; x77
    .FILL 613	; x78
    .FILL 613	; x79
    .FILL 613	; x7A
    .FILL 613	; x7B
    .FILL 613	; x7C
    .FILL 613	; x7D
    .FILL 613	; x7E
    .FILL 613	; x7F
    .FILL 613	; x80
    .FILL 613	; x81
    .FILL 613	; x82
    .FILL 613	; x83
    .FILL 613	; x84
    .FILL 613	; x85
    .FILL 613	; x86
    .FILL 613	; x87
    .FILL 613	; x88
    .FILL 613	; x89
    .FILL 613	; x8A
    .FILL 613	; x8B
    .FILL 613	; x8C
    .FILL 613	; x8D
    .FILL 613	; x8E
    .FILL 613	; x8F
    .FILL 613	; x90
    .FILL 613	; x91
    .FILL 613	; x92
    .FILL 613	; x93
    .FILL 613	; x94
    .FILL 613	; x95
    .FILL 613	; x96
    .FILL 613	; x97
    .FILL 613	; x98
    .FILL 613	; x99
    .FILL 613	; x9A
    .FILL 613	; x9B
    .FILL 613	; x9C
    .FILL 613	; x9D
    .FILL 613	; x9E
    .FILL 613	; x9F
    .FILL 613	; xA0
    .FILL 613	; xA1
    .FILL 613	; xA2
    .FILL 613	; xA3
    .FILL 613	; xA4
    .FILL 613	; xA5
    .FILL 613	; xA6
    .FILL 613	; xA7
    .FILL 613	; xA8
    .FILL 613	; xA9
    .FILL 613	; xAA
    .FILL 613	; xAB
    .FILL 613	; xAC
    .FILL 613	; xAD
    .FILL 613	; xAE
    .FILL 613	; xAF
    .FILL 613	; xB0
    .FILL 613	; xB1
    .FILL 613	; xB2
    .FILL 613	; xB3
    .FILL 613	; xB4
    .FILL 613	; xB5
    .FILL 613	; xB6
    .FILL 613	; xB7
    .FILL 613	; xB8
    .FILL 613	; xB9
    .FILL 613	; xBA
    .FILL 613	; xBB
    .FILL 613	; xBC
    .FILL 613	; xBD
    .FILL 613	; xBE
    .FILL 613	; xBF
    .FILL 613	; xC0
    .FILL 613	; xC1
    .FILL 613	; xC2
    .FILL 613	; xC3
    .FILL 613	; xC4
    .FILL 613	; xC5
    .FILL 613	; xC6
    .FILL 613	; xC7
    .FILL 613	; xC8
    .FILL 613	; xC9
    .FILL 613	; xCA
    .FILL 613	; xCB
    .FILL 613	; xCC
    .FILL 613	; xCD
    .FILL 613	; xCE
    .FILL 613	; xCF
    .FILL 613	; xD0
    .FILL 613	; xD1
    .FILL 613	; xD2
    .FILL 613	; xD3
    .FILL 613	; xD4
    .FILL 613	; xD5
    .FILL 613	; xD6
    .FILL 613	; xD7
    .FILL 613	; xD8
    .FILL 613	; xD9
    .FILL 613	; xDA
    .FILL 613	; xDB
    .FILL 613	; xDC
    .FILL 613	; xDD
    .FILL 613	; xDE
    .FILL 613	; xDF
    .FILL 613	; xE0
    .FILL 613	; xE1
    .FILL 613	; xE2
    .FILL 613	; xE3
    .FILL 613	; xE4
    .FILL 613	; xE5
    .FILL 613	; xE6
    .FILL 613	; xE7
    .FILL 613	; xE8
    .FILL 613	; xE9
    .FILL 613	; xEA
    .FILL 613	; xEB
    .FILL 613	; xEC
    .FILL 613	; xED
    .FILL 613	; xEE
    .FILL 613	; xEF
    .FILL 613	; xF0
    .FILL 613	; xF1
    .FILL 613	; xF2
    .FILL 613	; xF3
    .FILL 613	; xF4
    .FILL 613	; xF5
    .FILL 613	; xF6
    .FILL 613	; xF7
    .FILL 613	; xF8
    .FILL 613	; xF9
    .FILL 613	; xFA
    .FILL 613	; xFB
    .FILL 613	; xFC
    .FILL 613	; xFD
    .FILL 613	; xFE
    .FILL 613	; xFF
	
	;;; OS_START - operating system entry point (always starts at x0200)
	
	;; set MPR
	
OS_START 
    LD  R0, MPR_INIT 	;
    STI R0, OS_MPR 	;
	;; set timer interval
	
    LD  R0, TIM_INIT 	;
    STI R0, OS_TMI 	;
	;; start running user code (clear Privilege bit w/ JMPT)
	
    LD  R7, USER_CODE_ADDR 	;
    JMPT R7	;
	
OS_KBSR     .FILL xFE00	; keyboard status register
OS_KBDR     .FILL xFE02	; keyboard data register
OS_DSR     .FILL xFE04	; display status register
OS_DDR     .FILL xFE06	; display data register
OS_TR     .FILL xFE08	; timer register
OS_TMI     .FILL xFE0A	; timer interval register
OS_MPR     .FILL xFE12	; memory protection register
OS_MCR     .FILL xFFFE	; machine control register
	
OS_SAVE_R0     .FILL x0000	
OS_SAVE_R1     .FILL x0000	
OS_SAVE_R2     .FILL x0000	
OS_SAVE_R3     .FILL x0000	
OS_SAVE_R4     .FILL x0000	
OS_SAVE_R5     .FILL x0000	
OS_SAVE_R6     .FILL x0000	
OS_SAVE_R7     .FILL x0000	
OS_OUT_SAVE_R1     .FILL x0000	
OS_IN_SAVE_R7     .FILL x0000	
	
MASK_HI     .FILL x7FFF	
LOW_8_BITS     .FILL x00FF	
TIM_INIT     .FILL x0028	;MPR_INIT	.FILL xFFFF	; user can access everything
	
MPR_INIT     .FILL x0FF8	; user can access x3000 to xbfff
USER_CODE_ADDR     .FILL x3000	; user code starts at x3000
	
	;;; GETC - Read a single character of input from keyboard device into R0
	
	
TRAP_GETC 
    LDI R0, OS_KBSR 	; wait for a keystroke
     BRzp TRAP_GETC 	
    LDI R0, OS_KBDR 	; read it and return
    RET 	
	
	;;; OUT - Write the character in R0 to the console.
	
	
TRAP_OUT 
    ST  R1, OS_OUT_SAVE_R1 	; save R1
	
TRAP_OUT_WAIT 
    LDI R1, OS_DSR 	; wait for the display to be ready
     BRzp TRAP_OUT_WAIT 	
    STI R0, OS_DDR 	; write the character and return
    LD  R1, OS_OUT_SAVE_R1 	; restore R1
    RET 	
	
	;;; PUTS - Write a NUL-terminated string of characters to the console,
	;;; starting from the address in R0.
	
	
TRAP_PUTS 
    ST  R0, OS_SAVE_R0 	; save R0, R1, and R7
    ST  R1, OS_SAVE_R1 	
    ST  R7, OS_SAVE_R7 	
    ADD R1, R0, #0	; move string pointer (R0) into R1
	
	
TRAP_PUTS_LOOP 
    LDR R0, R1, #0	; write characters in string using OUT
     BRz TRAP_PUTS_DONE 	
    OUT 	
    ADD R1, R1, #1	
     BR TRAP_PUTS_LOOP 	
	
	
TRAP_PUTS_DONE 
    LD  R0, OS_SAVE_R0 	; restore R0, R1, and R7
    LD  R1, OS_SAVE_R1 	
    LD  R7, OS_SAVE_R7 	
    RET 	
	;;; IN - prompt the user for a single character input, which is stored
	;;; in R0 and also echoed to the console.
	
	
TRAP_IN 
    ST  R7, OS_IN_SAVE_R7 	; save R7 (no need to save R0, since we;    overwrite later
	
    LEA R0, TRAP_IN_MSG 	; prompt for input
    PUTS 	
    GETC 	; read a character
    OUT 	; echo back to monitor
    ST  R0, OS_SAVE_R0 	; save the character
    AND R0, R0, #0	; write a linefeed, too
    ADD R0, R0, #10	
    OUT 	
    LD  R0, OS_SAVE_R0 	; restore the character
    LD  R7, OS_IN_SAVE_R7 	; restore R7
    RET 	; this doesn't work, because
	
	;;; PUTSP - Write a NUL-terminated string of characters, packed 2 per
	;;; memory location, to the console, starting from the address in R0.
	
	; NOTE: This trap will end when it sees any NUL, even in
	; packed form, despite the P&P second edition's requirement
	; of a double NUL.
	
	
TRAP_PUTSP 
    ST  R0, OS_SAVE_R0 	; save R0, R1, R2, R3, and R7
    ST  R1, OS_SAVE_R1 	
    ST  R2, OS_SAVE_R2 	
    ST  R3, OS_SAVE_R3 	
    ST  R7, OS_SAVE_R7 	
    ADD R1, R0, #0	; move string pointer (R0) into R1
	
	
TRAP_PUTSP_LOOP 
    LDR R2, R1, #0	; read the next two characters
    LD  R0, LOW_8_BITS 	; use mask to get low byte
    AND R0, R0, R2	; if low byte is NUL, quit printing
     BRz TRAP_PUTSP_DONE 	
    OUT 	; otherwise print the low byte
	
    AND R0, R0, #0	; shift high byte into R0
    ADD R3, R0, #8	
	
TRAP_PUTSP_S_LOOP 
    ADD R0, R0, R0	; shift R0 left
    ADD R2, R2, #0	; move MSB from R2 into R0
     BRzp TRAP_PUTSP_MSB_0 	
    ADD R0, R0, #1	
	
TRAP_PUTSP_MSB_0 
    ADD R2, R2, R2	; shift R2 left
    ADD R3, R3, #-1	
     BRp TRAP_PUTSP_S_LOOP 	
	
    ADD R0, R0, #0	; if high byte is NUL, quit printing
     BRz TRAP_PUTSP_DONE 	
    OUT 	; otherwise print the low byte
	
    ADD R1, R1, #1	; and keep going
     BR TRAP_PUTSP_LOOP 	
	
	
TRAP_PUTSP_DONE 
    LD  R0, OS_SAVE_R0 	; restore R0, R1, R2, R3, and R7
    LD  R1, OS_SAVE_R1 	
    LD  R2, OS_SAVE_R2 	
    LD  R3, OS_SAVE_R3 	
    LD  R7, OS_SAVE_R7 	
    RET 	
	
	;;; HALT - trap handler for halting machine
	
	
TRAP_HALT 
    LDI R0, OS_MCR 	
    LD  R1, MASK_HI 	; clear run bit in MCR
    AND R0, R0, R1	
    STI R0, OS_MCR 	; halt!
     BR OS_START 	; restart machine
	
	;;; BAD_TRAP - code to execute for undefined trap
	
	
BAD_TRAP 
     BR TRAP_HALT 	; execute HALT
	
	;;; BAD_INT - code to execute for undefined interrupt. There won't
	;;; actually be any interrupts, so this will never actually get called.
	
BAD_INT 
    RTI 	
	
TRAP_IN_MSG     .FILL x000A	
    .FILL x0049	
    .FILL x006E	
    .FILL x0070	
    .FILL x0075	
    .FILL x0074	
    .FILL x0020	
    .FILL x0061	
    .FILL x0020	
    .FILL x0063	
    .FILL x0068	
    .FILL x0061	
    .FILL x0072	
    .FILL x0061	
    .FILL x0063	
    .FILL x0074	
    .FILL x0065	
    .FILL x0072	
    .FILL x003E	
    .FILL x0020	
    .FILL x0000	
    x0000	
.END
